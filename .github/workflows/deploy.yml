name: Deploy microservice to ECS

on:
  push:
    paths:
      - 'src/microservice/**'
  workflow_dispatch:
  pull_request:
    paths:
      - 'src/microservice/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - uses: actions/checkout@v4
    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
    - name: Login to ECR
      id: login-ecr
      run: |
        aws ecr get-login-password --region ${{ secrets.AWS_REGION || 'us-east-1' }} | docker login --username AWS --password-stdin $(aws sts get-caller-identity --query Account --output text).dkr.ecr.${{ secrets.AWS_REGION || 'us-east-1' }}.amazonaws.com
    - name: Build and push image
      run: |
        IMAGE_URI=$(jq -r '.ecr_microservice_uri.value' infra/terraform.tfstate 2>/dev/null || echo "${{ env.ECR_MICRO_URI }}")
        if [ -z "$IMAGE_URI" ]; then echo "Set ECR URI in env or ensure infra applied"; exit 1; fi
        SHORT=$(echo $GITHUB_SHA | cut -c1-7)
        docker build -t $IMAGE_URI:sha-$SHORT src/microservice
        docker push $IMAGE_URI:sha-$SHORT
    - name: Update ECS task with new image (manual/simple)
      run: |
        echo "This step assumes you have awscli configured role and permissions."
        # Fetch current task def, replace image, register and update service
        CLUSTER=$(terraform -chdir=infra output -raw ecs_cluster_name)
        SERVICE=$(terraform -chdir=infra output -json | jq -r '.ecs_cluster_name') || true
        echo "Cluster: $CLUSTER"
